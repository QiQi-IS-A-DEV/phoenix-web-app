<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quáº£n lÃ½ Ä‘Æ¡n hÃ ng</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f6f6f6; }
    h1 { color: #333; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
    form { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    input, select { padding: 6px; margin: 5px; }
    button { background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>

  <h1>ğŸ“¦ Quáº£n lÃ½ Ä‘Æ¡n hÃ ng</h1>

  <!-- ğŸ§¾ Form thÃªm Ä‘Æ¡n hÃ ng -->
  <form id="orderForm">
    <h3>â• ThÃªm Ä‘Æ¡n hÃ ng má»›i</h3>
    <label>KhÃ¡ch hÃ ng:</label>
    <select id="customerSelect"></select>

    <label>NhÃ¢n viÃªn:</label>
    <select id="employeeSelect"></select>

    <label>Tá»•ng tiá»n:</label>
    <input type="number" id="totalInput" placeholder="Nháº­p tá»•ng tiá»n..." required>

    <button type="submit">ThÃªm Ä‘Æ¡n</button>
  </form>

  <!-- ğŸ“‹ Báº£ng hiá»ƒn thá»‹ -->
  <table id="ordersTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>KhÃ¡ch hÃ ng</th>
        <th>NhÃ¢n viÃªn</th>
        <th>NgÃ y Ä‘áº·t</th>
        <th>Tá»•ng tiá»n</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // âš™ï¸ 1. Cáº¥u hÃ¬nh Supabase
    const SUPABASE_URL = "https://soytgkemnztaswrrmydl.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNveXRna2Vtbnp0YXN3cnJteWRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NjUzMDUsImV4cCI6MjA3NTM0MTMwNX0.RaCspYf6e74Ml5vEMH-GCuBPyaluQbyNcwXofXQB3ws";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // âš™ï¸ 2. Táº£i danh sÃ¡ch khÃ¡ch hÃ ng & nhÃ¢n viÃªn cho combobox
    async function loadCustomersAndEmployees() {
      const [customersRes, employeesRes] = await Promise.all([
        supabase.from("customers").select("id, name"),
        supabase.from("employees").select("id, name")
      ]);

      const customerSelect = document.getElementById("customerSelect");
      const employeeSelect = document.getElementById("employeeSelect");

      customersRes.data?.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        customerSelect.appendChild(opt);
      });

      employeesRes.data?.forEach(e => {
        const opt = document.createElement("option");
        opt.value = e.id;
        opt.textContent = e.name;
        employeeSelect.appendChild(opt);
      });
    }

    // ğŸ§  3. Hiá»ƒn thá»‹ danh sÃ¡ch Ä‘Æ¡n hÃ ng (join khÃ¡ch hÃ ng & nhÃ¢n viÃªn)
    async function loadOrders() {
      const { data, error } = await supabase
        .from("orders")
        .select(`
          id,
          total,
          order_date,
          customers ( name ),
          employees ( name )
        `)
        .order("order_date", { ascending: false });

      if (error) {
        console.error("Lá»—i khi táº£i Ä‘Æ¡n hÃ ng:", error);
        return;
      }

      const tbody = document.querySelector("#ordersTable tbody");
      tbody.innerHTML = "";

      data.forEach(o => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${o.id}</td>
          <td>${o.customers?.name ?? "(ChÆ°a cÃ³)"}</td>
          <td>${o.employees?.name ?? "(ChÆ°a cÃ³)"}</td>
          <td>${o.order_date ?? "-"}</td>
          <td>${(o.total ?? 0).toLocaleString('vi-VN')}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ğŸ§© 4. Xá»­ lÃ½ thÃªm Ä‘Æ¡n hÃ ng má»›i
    const form = document.getElementById("orderForm");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const customer_id = document.getElementById("customerSelect").value;
      const employee_id = document.getElementById("employeeSelect").value;
      const total = parseFloat(document.getElementById("totalInput").value);

      const { error } = await supabase.from("orders").insert([
        { customer_id, employee_id, total }
      ]);

      if (error) {
        alert("âŒ Lá»—i khi thÃªm Ä‘Æ¡n hÃ ng: " + error.message);
      } else {
        alert("âœ… ÄÃ£ thÃªm Ä‘Æ¡n hÃ ng thÃ nh cÃ´ng!");
        form.reset();
        loadOrders();
      }
    });

    // ğŸš€ 5. Khá»Ÿi cháº¡y khi má»Ÿ trang
    loadCustomersAndEmployees();
    loadOrders();
  </script>

</body>
</html>
