<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quản lý đơn hàng</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f6f6f6; }
    h1 { color: #333; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
    form { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    input, select { padding: 6px; margin: 5px; }
    button { background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>

  <h1>📦 Quản lý đơn hàng</h1>

  <!-- 🧾 Form thêm đơn hàng -->
  <form id="orderForm">
    <h3>➕ Thêm đơn hàng mới</h3>
    <label>Khách hàng:</label>
    <select id="customerSelect"></select>

    <label>Nhân viên:</label>
    <select id="employeeSelect"></select>

    <label>Tổng tiền:</label>
    <input type="number" id="totalInput" placeholder="Nhập tổng tiền..." required>

    <button type="submit">Thêm đơn</button>
  </form>

  <!-- 📋 Bảng hiển thị -->
  <table id="ordersTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Khách hàng</th>
        <th>Nhân viên</th>
        <th>Ngày đặt</th>
        <th>Tổng tiền</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // ⚙️ 1. Cấu hình Supabase
    const SUPABASE_URL = "https://soytgkemnztaswrrmydl.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNveXRna2Vtbnp0YXN3cnJteWRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NjUzMDUsImV4cCI6MjA3NTM0MTMwNX0.RaCspYf6e74Ml5vEMH-GCuBPyaluQbyNcwXofXQB3ws";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ⚙️ 2. Tải danh sách khách hàng & nhân viên cho combobox
    async function loadCustomersAndEmployees() {
      const [customersRes, employeesRes] = await Promise.all([
        supabase.from("customers").select("id, name"),
        supabase.from("employees").select("id, name")
      ]);

      const customerSelect = document.getElementById("customerSelect");
      const employeeSelect = document.getElementById("employeeSelect");

      customersRes.data?.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        customerSelect.appendChild(opt);
      });

      employeesRes.data?.forEach(e => {
        const opt = document.createElement("option");
        opt.value = e.id;
        opt.textContent = e.name;
        employeeSelect.appendChild(opt);
      });
    }

    // 🧠 3. Hiển thị danh sách đơn hàng (join khách hàng & nhân viên)
    async function loadOrders() {
      const { data, error } = await supabase
        .from("orders")
        .select(`
          id,
          total,
          order_date,
          customers ( name ),
          employees ( name )
        `)
        .order("order_date", { ascending: false });

      if (error) {
        console.error("Lỗi khi tải đơn hàng:", error);
        return;
      }

      const tbody = document.querySelector("#ordersTable tbody");
      tbody.innerHTML = "";

      data.forEach(o => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${o.id}</td>
          <td>${o.customers?.name ?? "(Chưa có)"}</td>
          <td>${o.employees?.name ?? "(Chưa có)"}</td>
          <td>${o.order_date ?? "-"}</td>
          <td>${(o.total ?? 0).toLocaleString('vi-VN')}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 🧩 4. Xử lý thêm đơn hàng mới
    const form = document.getElementById("orderForm");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const customer_id = document.getElementById("customerSelect").value;
      const employee_id = document.getElementById("employeeSelect").value;
      const total = parseFloat(document.getElementById("totalInput").value);

      const { error } = await supabase.from("orders").insert([
        { customer_id, employee_id, total }
      ]);

      if (error) {
        alert("❌ Lỗi khi thêm đơn hàng: " + error.message);
      } else {
        alert("✅ Đã thêm đơn hàng thành công!");
        form.reset();
        loadOrders();
      }
    });

    // 🚀 5. Khởi chạy khi mở trang
    loadCustomersAndEmployees();
    loadOrders();
  </script>

</body>
</html>
